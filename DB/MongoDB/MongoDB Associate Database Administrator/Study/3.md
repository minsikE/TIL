# 3주차
## Unit 8. MongoDB Indexes
### Lesson 1. Using MongoDB Indexes in Collections
#### What indexes are

- Special data structures for fast data retrieval
- Store small portion of the data
- Ordered and easy to search efficiently
- Point to the document identity
- allow you to look up access and update data faster
- Support equality matches and range-based operations and return sorted results

#### How indexes can improve performance

- Speed up queries
- Reduce disk I/O
- Reduce resources required
- With indexes, MongoDB only fetches the documents identified by the index based on the query.
- Returns results faster
- There is one default index per collection, which includes only the _id field.
- Every query should use an index
- cursor.explain(”executionStats”)
    - 인덱스를 이용한 쿼리의 효과를 이해하는데 도움
        - nReturned : 반환받은 결과의 개수
        - totalDocsExamined : 몽고DB가 쿼리를 실행하면서 살펴본 도큐먼트 개수
        - executionTimeMillis : 쿼리 계획 선택과 쿼리 실행에 필요한 총 시간(밀리초 단위)

##### Without indexes

- MongoDB reads all documents (`Collection Scan`)
- Sorts results in memory

#### Costs of using indexes

- If we insert or update documents, we need to update the index data structure
- Delete unnecessary or redundant indexes

#### Most common index types

##### Single field

- Indexes on one field only

##### Compound

- Indexes include more than one field in the index.

##### Multikey indexes operate on an array field

- Each array entry has a corresponding index entry.

---

#### Quiz.

1. **Which of the following statements about indexes are correct? (Select all the that apply.)**
- **A.** Indexes are data structures that improve performance, support efficient equality matches and range-based query operations, and can return sorted results.
    
    **Correct.**
    
    Indexes are data structures that improve performance, support efficient equality matches and range-based query operations, and can return sorted results. Indexes achieve this by allowing MongoDB to perform only the work necessary to return the data that is requested, rather than scanning the entire collection.
    
- **B.** Indexes are automatically created based on usage patterns.
    
    **Incorrect.**
    
    While users can create indexes on the data that's used most often to help improve the performance of a slow query, indexes are not automatically created based on usage patterns. However, MongoDB Atlas provides recommendations about which indexes to create or drop.
    
- **C.** Indexes are used to make querying faster for users. One of the easiest ways to improve the performance of a slow query is create indexes on the data that is used most often.
    
    **Correct.**
    
    Indexes help make querying faster for users by only scanning the indexes to find the data that is requested.
    
- **D.** When using an index, MongoDB reads every document in a collection to check if it matches the query that's being run.
    
    **Incorrect.**
    
    When indexes are available, MongoDB does not need to scan the entire collection to return the data that is requested by a query. Instead, MongoDB will only scan the indexes to find the data that is requested.
    

2. **Which of the following statements about indexes are true? (Select one.)**
- **A.** Indexes improve query performance and have no impact on write performance.
    
    **Incorrect.**
    
    While indexes improve query performance, they do come with a cost. For example, any time you run a write operation, all the indexes must be updated, which can be time-consuming.
    
- **B.** Indexes improve query performance at the cost of write performance.
    
    **Correct!**
    
    Indexes improve query performance at the cost of write performance. For most use cases, this tradeoff is acceptable. Indexes should be used on data that is frequently queried or on queries that are infrequent but costly in terms of computational resources.
    
- **C.** Indexes have no impact on query performance but improve write performance.
    
    **Incorrect.**
    
    Indexes improve query performance by allowing the database to use indexes to speed up the query process. However, indexes do come with a cost. For example, any time you run a write operation, all the indexes must be updated, which can be time-consuming.
    
- **D.** Indexes have a negative impact on query performance but improve write performance.
    
    **Incorrect.**
    
    Indexes have a positive impact on query performance but come with a cost. For example, any time you run a write operation, all the indexes must be updated, which can be time-consuming.


### Lesson 2. Creating a Single Field Index in MongoDB
#### **A single field index**

- an index that supports efficient querying against a single field.
- By default, all collections have a single field index on the `_id` field,
- but users can define additional indexes that support important queries.
- A single field index is also a multikey index if the value of the field is an array.

##### Create a Single Field Index

- Use `createIndex()` to create a new index in a collection.
- Within the parentheses of `createIndex()`, include an object that contains the field and sort order.

```scss
// syntax
db.collection.createIndex({fieldname:1})

db.customers.createIndex({
  birthdate: 1 // ascending
})

// birthdate_1 생성됨
```

- createIndex 호출이 몇 초 후에 반환되지 않을 때
    - db.currentOp() 또는 mongod의 로그를 확인해 인덱스 구축의 진행률 체크 가능
        - db.currentOp()
            
            ```json
            	MongoServerError[AtlasError]: Error validating $currentOp value. arg=allUsers isn't allowed in this atlas tier
            ```
            
        - mongod 로그
            
            ```json
            {"t":{"$date":"2024-07-17T06:00:11.666Z"},"s":"I","c":"MONGOSH","id":1000000007,"ctx":"repl","msg":"Evaluating input","attr":{"input":"db.customers.createIndex({\nbirthdate: 1\n})"}}
            {"t":{"$date":"2024-07-17T06:00:11.668Z"},"s":"I","c":"MONGOSH","id":1000000011,"ctx":"shell-api","msg":"Performed API call","attr":{"method":"createIndex","class":"Collection","db":"sample_analytics","coll":"customers","arguments":{"keys":{"birthdate":1},"options":{}}}}
            ```
            

##### Create a Unique Single Field Index

- Add `{unique:true}` as a second, optional, parameter in `createIndex()` to force uniqueness in the index field values. Once the unique index is created, any inserts or updates including duplicated values in the collection for the index field/s will fail.

```scss
db.customers.createIndex({ email: 1 }, { unique:true })
```

- MongoDB only creates the unique index if there is no duplication in the field values for the index field/s.
    - MongoServerError: E11000 duplicate key error collection

##### View the Indexes used in a Collection

- Use `getIndexes()` to see all the indexes created in a collection.

```scss
db.customers.getIndexes()
```

- Atlas에서도 Collection 내 Index 확인 가능

##### Check if an index is being used on a query

- Use `explain()` in a collection when running a query to see the Execution plan.
- This plan provides the details of the execution stages (IXSCAN , COLLSCAN, FETCH, SORT, etc.).
    - The `IXSCAN` stage indicates the query is using an index and what index is being selected.
    - The `COLLSCAN` stage indicates a collection scan is perform, not using any indexes.
    - The `FETCH` stage indicates documents are being read from the collection.
    - The `SORT` stage indicates documents are being sorted in memory.

```scss
db.customers.explain().find({
  birthdate: {
    $gt:ISODate("1995-08-01")
    }
  })
```

```scss
db.customers.explain().find({
  birthdate: {
    $gt:ISODate("1995-08-01")
    }
  }).sort({
    email:1
    })
 
db.customers.explain().find({accounts:871666})
```

---

#### Quiz

1. **What is a single field index? (Select one.)**
- **A.** An index that supports efficient querying against one field
    
    **Correct.**
    
    A single field index is an index that supports efficient querying against a single field. By default, all collections have a single field index on the `_id` field, but users can define additional indexes that support important queries. A single field index is also a multikey index if the value of the field is an array.
    
- **B.** An index that supports efficient querying against multiple fields
    
    **Incorrect.**
    
    An index that supports efficient queries against multiple fields is called a compound index.
    
- **C.** An index that only supports efficient querying against fields with scalar values
    
    **Incorrect.**
    
    Single field indexes can also support efficient querying against a single array field.
    
- **D.** An index that supports efficient querying against fields that are already indexed by another user-defined index
    
    **Incorrect.**
    
    A single field index doesn't support efficient querying against fields that are already indexed by another user-defined index. When a single field is already indexed—for example, by a compound index—creating an additional single field index can cause over-indexing and performance issues.
    

2. **You have a collection of customer details. The following is a sample document from the collection:**

```json
{
  "_id": { "$oid": "5ca4bbcea2dd94ee58162a6a" },
  "username": "hillrachel",
  "name": "Katherine David",
  "address": "55711 Janet Plaza Apt. 865\nChristinachester, CT 62716",
  "birthdate": { "$date": { "$numberLong": "582848134000" } },
  "email": "timothy78@hotmail.com",
  "Accounts": [
    { "$numberInt": "462501" },
    { "$numberInt": "228290" },
    { "$numberInt": "968786" },
    { "$numberInt": "515844" },
    { "$numberInt": "377292" }
  ],
  "tier_and_details": {}
}
```

**You create a single field index on the email field, with the unique constraint set to true:**

```scss
db.customers.createIndex({email:1}, {unique:true})
```

**What would happen if you attempt to insert a new document with an email that already exists in the collection? (Select one.)**

- **A.** The new document will be inserted and replace the old document in the collection.
    
    **Incorrect.**
    
    That is not how the `unique` constraint operates. Unique indexes ensure that indexed fields do not store duplicate values. The new document will not be inserted in this example because the email address already exists in another document in the collection.
    
- **B.** The new document will be inserted and the old document will remain in the collection.
    
    **Incorrect.**
    
    That is not how the `unique` constraint operates. Unique indexes ensure that indexed fields do not store duplicate values. The new document will not be inserted in this example. Because the email address already exists in another document in the collection, the unique constraint would prevent the new document from being inserted.
    
- **C.** MongoDB will return a duplicate key error, and the document will be inserted.
    
    **Incorrect.**
    
    That is not how the `unique` constraint operates. Unique indexes ensure that indexed fields do not store duplicate values. While a duplicate error key would be returned, the new document would not be inserted in this example because the email address already exists in another document in the collection.
    
- **D.** MongoDB will return a duplicate key error, and the document will not be inserted.
    
    **Correct.**
    
    Unique indexes ensure that indexed fields do not store duplicate values. In this example, MongoDB will return a duplicate key error if you attempt to insert a new document with an email that already exists in the collection, as the `unique` constraint was set to `true`.

### Lesson 3. Creating a Multikey Index in MongoDB
#### Multikey indexes

- Index on an array field
- can index primitives, subdocuments, or subarrays.
- can be single field or compound index
    
    ```json
    // accounts 필드가 array일 경우
    db.customers.createIndex({accounts:1})
    db.customers.createIndex({email:1, accounts:1})
    
    // 모두 Multikey indexes라고 할 수 있
    ```
    
- There is a limitation of only one array field per index.

```json
// accounts index 생성 전 explain()으로 확인
db.customers.explain().find({accounts:627788})
// accounts index 생성
db.customers.createIndex({accounts:1})
// accounts index 생성 후 explain()으로 확인
db.customers.explain().find({accounts:627788})
```

---

#### Quiz

1. **What is a multikey index? (Select one.)**
- **A.** An index on one field only where the field is not an array
    
    **Incorrect.**
    
    A multikey index is any index where one of the indexed fields contains an array, including both single field and compound indexes. In a compound index, only one of the fields can be an array.
    
- **B.** An index where one of the indexed fields contains an array
    
    **Correct.**
    
    Multikey indexes support efficient queries against array fields by creating an index key for each element in the array. This allows MongoDB to search for the index key of each element in the array rather than scan the entire array, which results in dramatic performance gains in your queries.
    
- **C.** An index on more than one field where none of the fields are arrays
    
    **Incorrect.**
    
    A multikey index is any index where one of the indexed fields contains an array, including both single field and compound indexes. In a compound index, only one of the fields can be an array.
    
- **D.** An index on more than one field where multiple fields are arrays
    
    **Incorrect.**
    
    A multikey index is any index where one of the indexed fields contains an array, including both single field and compound indexes. In a compound index, only one of the fields can be an array.
    

2. **What is the maximum number of array fields per multikey index? (Select one.)**
- **A.** 1
    
    Correct! The maximum number of array fields per multikey index is 1. If an index has multiple fields, only one of them can be an array.
    
- **B.** 3
    
    Incorrect. The maximum number of array fields per multikey index is not 3. However, there is a limitation on the number of array fields per index.
    
- **C.** 5
    
    Incorrect. The maximum number of array fields per multikey index is not 5. However, there is a limitation on the number of array fields per index.
    
- **D.** Unlimited
    
    Incorrect. The maximum number of array fields per multikey index is not unlimited.

### Lesson 5. Deleting MongoDB Indexes
#### View the Indexes used in a Collection

- Use `getIndexes()` to see all the indexes created in a collection.
- There is always a default index in every collection on _id field.
- This index is used by MongoDB internally and cannot be deleted.

#### Delete an Index

- Indexes improve performance but have a write cost.
    - Too many indexes in a collection can affect system performance.
        - Delete unused or redundant indexes
    - Recreating an index takes time and resources
    - Hide the index before deleting it
        - db.collection.hideIndex(<index>)
        
        ```json
        db.customers.hideIndex('active_1_birthdate_-1_name_1')
        db.customers.hideIndex({active:1,birthdate:-1,name:1})
        ```
        
- Use `dropIndex()` to delete an existing index from a collection.
- Within the parentheses of `dropIndex()`, include an object representing the index key or provide the index name as a string.
    - Delete index by name:
        - db.customers.dropIndex(  'active_1_birthdate_-1_name_1' )
    - Delete index by key:
        - db.customers.dropIndex({  active:1,   birthdate:-1,   name:1 })

#### Delete Indexes

Use `dropIndexes()` to delete all the indexes from a collection, with the exception of the default index on _id.

```scss
db.customers.dropIndexes()
```

The `dropIndexes()` command also can accept an array of index names as a parameter to delete a specific list of indexes.

```sql
db.collection.dropIndexes('indexName')
db.collection.dropIndexes([ 'index1name', 'index2name', 'index3name' ])
```

---

#### Quiz

1. What are the ramifications of deleting an index that is supporting a query? (Select one.)
- **A.** The performance of the query will improve.
    
    **Incorrect.**
    
    Deleting an index that is supporting a query won’t improve the performance. However, it might cause MongoDB to have to scan the entire database to find the documents that match the query.
    
- **B.** The performance of the query will be negatively affected.
    
    **Correct!**
    
    The performance of the query will be negatively affected by the deletion of the only index that is currently supporting that query. Indexes generally improve the performance and time efficiency of queries by reducing the number of times that the database needs to be accessed.
    
- **C.** The query will fail.
    
    **Incorrect.**
    
    Deleting the only index that is supporting a query won't cause it to fail. However, it might cause MongoDB to have to scan the entire database to find the documents that match the query.
    
- **D.** The query will perform as expected.
    
    **Incorrect.**
    
    Deleting an index that is supporting a query will have an impact. It might cause MongoDB to have to scan the entire database to find the documents that match the query.
    

2. **You have a collection of customer details. The following is a sample document from this collection:**

```json
{
  "_id": { "$oid": "5ca4bbcea2dd94ee58162a6a" },
  "username": "hillrachel",
  "name": "Katherine David",
  "address": "55711 Janet Plaza Apt. 865\nChristinachester, CT 62716",
  "birthdate": { "$date": { "$numberLong": "582848134000" } },
  "email": "timothy78@hotmail.com",
  "Accounts": [
    { "$numberInt": "462501" },
    { "$numberInt": "228290" },
    { "$numberInt": "968786" },
    { "$numberInt": "515844" },
    { "$numberInt": "377292" }
  ],
  "tier_and_details": {}
}
```

**You have an index on the `email` field. Here’s the command you used to create the index:**

```scss
db.customers.createIndex({email:1})
```

**Before deleting it, you want to assess the impact of removing this index on the performance of the query. To do this, which command should you use? (Select one.)**

- **A.** dropIndex()
    
    **Incorrect.**
    
    The `dropIndex()` command deletes an index. Deleting the only index supporting a query will affect the performance of that query. You should hide the index before deleting it. This way, you'll be able to assess the impact of removing the index on query performance. What command is used to hide indexes?
    
- **B.** dropIndexes()
    
    **Incorrect.**
    
    The `dropIndexes()` command deletes multiple indexes. Deleting the only index supporting a query will affect the performance of that query. You should hide the index before deleting it. This way, you'll be able to assess the impact of removing the index on query performance. What command is used to hide indexes?
    
- **C.** getIndexes()
    
    **Incorrect.**
    
    The `getIndexes()` command returns an array that holds a list of documents that identify and describe the existing indexes on the collection, including hidden indexes. What command is used to hide indexes?
    
- **D.** hideIndex()
    
    **Correct.**
    
    The `hideIndex()` command hides an index. By hiding an index, you'll be able to assess the impact of removing the index on query performance. MongoDB does not use hidden indexes in queries but continues to update their keys. This allows you to assess if removing the index affects the query performance and unhide the index if needed. Unhiding an index is faster than recreating it. In this example, you would use the command `db.customers.hideIndex({email:1})`.

### Summary

- Single-field (one field)
- Compound (2 to 32 fields)

We worked with index properties like unique and understood that Multikey indexes are indexes that include one array field.

We used the following commands in the collection to create or delete indexes:

- createIndex()
- dropIndex()

Finally, we learned how to view the indexes being used in a collection with the `getIndexes()` command and how to check if the index is being used in a query by executing the `explain()` command.

#### Resources

Use the following resources to learn more about indexes in MongoDB:

##### Lesson 1 - Using MongoDB Indexes in Collections

- [MongoDB Docs: Indexes](https://www.mongodb.com/docs/manual/indexes/?_ga=2.67626584.810066485.1665291537-836515500.1666025886)
- [MongoDB Docs: Indexes Reference](https://www.mongodb.com/docs/manual/reference/indexes/?_ga=2.67626584.810066485.1665291537-836515500.1666025886)

##### Lesson 2 - Creating a Single Field Index in MongoDB

- [MongoDB Docs: createIndex()](https://www.mongodb.com/docs/manual/reference/method/db.collection.createIndex/?_ga=2.67626584.810066485.1665291537-836515500.1666025886)
- [MongoDB Docs: Unique Indexes](https://www.mongodb.com/docs/manual/core/index-unique/?_ga=2.55479138.810066485.1665291537-836515500.1666025886)
- [MongoDB Docs: Measure Index Use](https://www.mongodb.com/docs/manual/tutorial/measure-index-use/?_ga=2.55479138.810066485.1665291537-836515500.1666025886)
- [MongoDB Docs: getIndexes()](https://www.mongodb.com/docs/manual/reference/method/db.collection.getIndexes/?_ga=2.55479138.810066485.1665291537-836515500.1666025886)

##### Lesson 3 - Creating a Multikey Index in MongoDB

- [MongoDB Docs: Multikey Indexes](https://www.mongodb.com/docs/manual/core/index-multikey/?_ga=2.55479138.810066485.1665291537-836515500.1666025886)

##### Lesson 4 - Working with Compound Indexes in MongoDB

- [MongoDB Docs: Compound Indexes](https://www.mongodb.com/docs/manual/core/index-compound/?_ga=2.55479138.810066485.1665291537-836515500.1666025886)
- [MongoDB Docs: Indexing Strategies](https://www.mongodb.com/docs/manual/applications/indexes/?_ga=2.55479138.810066485.1665291537-836515500.1666025886)

##### Lesson 5 - Deleting MongoDB Indexes

- [MongoDB Docs: dropIndex()](https://www.mongodb.com/docs/manual/reference/method/db.collection.dropIndex/?_ga=2.55479138.810066485.1665291537-836515500.1666025886)
- [MongoDB Docs: dropIndexes()](https://www.mongodb.com/docs/manual/reference/method/db.collection.dropIndexes/?_ga=2.55479138.810066485.1665291537-836515500.1666025886)

## Unit 9. MongoDB Indexes II
### Lesson 1. How Indexes Work
